#!/usr/bin/env ruby

puts "🗄️ Cally - Database Setup"
puts "=" * 40

# Check RVM environment
if ENV['GEM_HOME'] && ENV['GEM_HOME'].include?('ruby-3.4.1@cally')
  puts "✅ Using correct RVM environment: #{ENV['GEM_HOME'].split('/').last}"
else
  puts "⚠️  Warning: May not be using correct RVM gemset"
  puts "   Expected: ruby-3.4.1@cally"
  puts "   Current: #{ENV['GEM_HOME']&.split('/')&.last || 'unknown'}"
  puts "   Please run: rvm use ruby-3.4.1@cally"
  puts ""
end

# Setup database for chat history storage
begin
  puts "📊 Creating SQLite database..."
  system('rails db:create')
  
  puts "🔄 Running database migrations..."
  system('rails db:migrate')
  
  puts "🌱 Seeding database..."
  system('rails db:seed')
  
  puts ""
  puts "✅ Database setup complete!"
  puts "📈 SQLite database is ready for fast chat history storage"
  puts ""
  puts "Benefits of SQLite over JSON:"
  puts "  • ⚡ Much faster queries and operations"
  puts "  • 🔍 Easy searching and filtering"
  puts "  • 📊 Better data integrity and validation"
  puts "  • 🚀 Scalable for thousands of conversations"
  puts ""
  
rescue => e
  puts "❌ Database setup failed: #{e.message}"
  puts ""
  puts "Fallback: The app will use JSON file logging if database is unavailable"
  exit 1
end
