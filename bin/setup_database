#!/usr/bin/env ruby

puts "ğŸ—„ï¸ Cally - Database Setup"
puts "=" * 40

# Check RVM environment
if ENV['GEM_HOME'] && ENV['GEM_HOME'].include?('ruby-3.4.1@cally')
  puts "âœ… Using correct RVM environment: #{ENV['GEM_HOME'].split('/').last}"
else
  puts "âš ï¸  Warning: May not be using correct RVM gemset"
  puts "   Expected: ruby-3.4.1@cally"
  puts "   Current: #{ENV['GEM_HOME']&.split('/')&.last || 'unknown'}"
  puts "   Please run: rvm use ruby-3.4.1@cally"
  puts ""
end

# Setup database for chat history storage
begin
  puts "ğŸ“Š Creating SQLite database..."
  system('rails db:create')
  
  puts "ğŸ”„ Running database migrations..."
  system('rails db:migrate')
  
  puts "ğŸŒ± Seeding database..."
  system('rails db:seed')
  
  puts ""
  puts "âœ… Database setup complete!"
  puts "ğŸ“ˆ SQLite database is ready for fast chat history storage"
  puts ""
  puts "Benefits of SQLite over JSON:"
  puts "  â€¢ âš¡ Much faster queries and operations"
  puts "  â€¢ ğŸ” Easy searching and filtering"
  puts "  â€¢ ğŸ“Š Better data integrity and validation"
  puts "  â€¢ ğŸš€ Scalable for thousands of conversations"
  puts ""
  
rescue => e
  puts "âŒ Database setup failed: #{e.message}"
  puts ""
  puts "Fallback: The app will use JSON file logging if database is unavailable"
  exit 1
end
